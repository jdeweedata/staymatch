generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuid_ossp(map: "uuid-ossp", schema: "extensions"), vector]
}

model User {
  id                 String                 @id @default(cuid())
  email              String                 @unique
  passwordHash       String?
  name               String?
  avatarUrl          String?
  tasteVector        Unsupported("vector")?
  preferences        Json?
  dealBreakers       String[]
  delightFactors     String[]
  onboardingComplete Boolean                @default(false)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  bookings           Booking[]
  contributions      Contribution[]
  sessions           Session[]
  swipes             Swipe[]

  @@index([email])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Swipe {
  id           String         @id @default(cuid())
  userId       String
  hotelImageId String
  direction    SwipeDirection
  createdAt    DateTime       @default(now())
  hotelImage   HotelImage     @relation(fields: [hotelImageId], references: [id])
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, hotelImageId])
  @@index([userId])
}

model HotelCache {
  id                  String                 @id
  name                String
  city                String
  country             String
  latitude            Float?
  longitude           Float?
  starRating          Float?
  description         String?
  amenities           String[]
  images              Json
  embedding           Unsupported("vector")?
  avgWifiDownload     Float?
  avgWifiUpload       Float?
  wifiTestCount       Int                    @default(0)
  avgNoiseLevel       Float?
  noiseTestCount      Int                    @default(0)
  communityRating     Float?
  contributionCount   Int                    @default(0)
  hasHotWater         Boolean?
  hasBlackoutCurtains Boolean?
  hasQuietRooms       Boolean?
  hasGoodAC           Boolean?
  hasWorkDesk         Boolean?
  truthScore          Float?
  truthConfidence     Float?
  lastSynced          DateTime               @default(now())
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  bookings            Booking[]
  contributions       Contribution[]
  hotelImages         HotelImage[]

  @@index([city])
  @@index([truthScore])
}

model HotelImage {
  id          String     @id @default(cuid())
  hotelId     String
  imageUrl    String
  category    String?
  isActive    Boolean    @default(true)
  inSwipeDeck Boolean    @default(false)
  createdAt   DateTime   @default(now())
  hotel       HotelCache @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  swipes      Swipe[]

  @@index([hotelId])
  @@index([inSwipeDeck])
}

model Booking {
  id                      String        @id @default(cuid())
  userId                  String
  liteapiBookingId        String        @unique
  liteapiHotelId          String
  hotelName               String
  city                    String
  checkIn                 DateTime
  checkOut                DateTime
  roomType                String
  guestCount              Int
  totalPrice              Decimal       @db.Decimal(10, 2)
  currency                String        @default("USD")
  commission              Decimal?      @db.Decimal(10, 2)
  commissionRate          Float?
  guestFirstName          String
  guestLastName           String
  guestEmail              String
  status                  BookingStatus @default(CONFIRMED)
  cancellationDate        DateTime?
  contributionRequested   Boolean       @default(false)
  contributionRequestedAt DateTime?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  hotel                   HotelCache    @relation(fields: [liteapiHotelId], references: [id])
  user                    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  contribution            Contribution?

  @@index([userId])
  @@index([status])
  @@index([checkOut])
}

model Contribution {
  id               String              @id @default(cuid())
  userId           String
  bookingId        String              @unique
  hotelId          String
  wifiDownload     Float?
  wifiUpload       Float?
  wifiPing         Float?
  wifiFloor        String?
  wifiTestedAt     DateTime?
  hotWaterReliable Boolean?
  blackoutCurtains Boolean?
  quietAtNight     Boolean?
  acWorksWell      Boolean?
  workDeskPresent  Boolean?
  additionalNotes  String?
  discountCode     String?             @unique
  discountUsed     Boolean             @default(false)
  discountUsedAt   DateTime?
  verified         Boolean             @default(false)
  verifiedAt       DateTime?
  createdAt        DateTime            @default(now())
  booking          Booking             @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  hotel            HotelCache          @relation(fields: [hotelId], references: [id])
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  photos           ContributionPhoto[]

  @@index([hotelId])
  @@index([verified])
}

model ContributionPhoto {
  id             String        @id @default(cuid())
  contributionId String
  category       PhotoCategory
  imageUrl       String
  thumbnailUrl   String?
  createdAt      DateTime      @default(now())
  contribution   Contribution  @relation(fields: [contributionId], references: [id], onDelete: Cascade)

  @@index([contributionId])
}

model DiscountCode {
  id          String    @id @default(cuid())
  code        String    @unique
  discount    Float
  validUntil  DateTime
  usedAt      DateTime?
  usedByEmail String?
  createdAt   DateTime  @default(now())

  @@index([code])
  @@index([validUntil])
}

enum SwipeDirection {
  LEFT
  RIGHT
  SUPER_LIKE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PhotoCategory {
  LOBBY
  ROOM
  VIEW
}
